<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sand Particles with SVG</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: #111;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

<script>

const getCountElemens = () => {
  const w = window.innerWidth;
  if(w > 2000) return 700;
  if(w > 1700) return 600;
  if(w > 1400) return 500;
  if(w > 1200) return 400;
  if(w > 900) return 300;
  if(w > 600) return 250;
  return 250;

}

  // SVG texture generator
  const createSVGTexture = (shape, fill) => {
    let svg = "";
    if (shape === "arrow") {
      svg = `<svg xmlns="http://www.w3.org/2000/svg" width="53" height="41" viewBox="0 0 53 41">
        <path d="M0.25 19L52.46 0.66C50.66 1.99 49.05 3.28 47.62 4.54C34.64 15.96 36.86 24.77 51.17 40.71L0.25 19Z" fill="${fill}"/>
      </svg>`;
    }
    if (shape === "circle") {
      svg = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
        <circle cx="20" cy="20" r="18" fill="${fill}" />
      </svg>`;
    }
    if (shape === "plus") {
      svg = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
        <rect x="17" y="5" width="6" height="30" fill="${fill}" />
        <rect x="5" y="17" width="30" height="6" fill="${fill}" />
      </svg>`;
    }
    const blob = new Blob([svg], { type: "image/svg+xml" });
    return URL.createObjectURL(blob);
  };

  const textures = [
    createSVGTexture("arrow", "black"),
    createSVGTexture("arrow", "blue"),
    createSVGTexture("circle", "black"),
    createSVGTexture("circle", "blue"),
    createSVGTexture("plus", "black"),
    createSVGTexture("plus", "blue"),
  ];

  const {
    Engine, Render, Runner, World,
    Bodies, Body, Events, Mouse, Query
  } = Matter;

  const canvas = document.getElementById("canvas");
  const width = window.innerWidth;
  const height = window.innerHeight;

  const engine = Engine.create();
  const world = engine.world;

  const render = Render.create({
    canvas,
    engine,
    options: {
      width,
      height,
      background: '#111',
      wireframes: false,
      pixelRatio: window.devicePixelRatio,
    }
  });

  Render.run(render);
  Runner.run(Runner.create(), engine);

  // Стены
  const ground = Bodies.rectangle(width / 2, height + 20, width, 40, { isStatic: true });
  const wallLeft = Bodies.rectangle(-20, height / 2, 40, height, { isStatic: true });
  const wallRight = Bodies.rectangle(width + 20, height / 2, 40, height, { isStatic: true });
  World.add(world, [ground, wallLeft, wallRight]);

  // Положение мыши
  const mousePos = { x: -9999, y: -9999 };
  window.addEventListener("mousemove", e => {
    mousePos.x = e.clientX;
    mousePos.y = e.clientY;
  });

  // Генерация песчинок с текстурами
  const createParticle = (x, y) => {
    const radius = 17;
    const body = Bodies.circle(x, y, radius, {
      restitution: 0.05,
      friction: 0.05,
      frictionAir: 0.01,
      render: {
        sprite: {
          texture: textures[Math.floor(Math.random() * textures.length)],
          xScale: 0.5,
          yScale: 0.5
        }
      }
    });
    return body;
  };

  // Создание частиц
  const PARTICLE_COUNT = getCountElemens();
  for (let i = 0; i < PARTICLE_COUNT; i++) {
    const x = Math.random() * width;
    const y = -Math.random() * height;
    const p = createParticle(x, y);
    World.add(world, p);
  }

  // Отталкивание мышью
  Events.on(engine, "beforeUpdate", () => {
    const radius = 90;
    const strength = 0.03;

    const region = {
      min: { x: mousePos.x - radius, y: mousePos.y - radius },
      max: { x: mousePos.x + radius, y: mousePos.y + radius }
    };

    const bodies = Query.region(world.bodies, region);
    for (let body of bodies) {
      if (body.isStatic) continue;

      const dx = body.position.x - mousePos.x;
      const dy = body.position.y - mousePos.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist < radius) {
        const force = (1 - dist / radius) * strength;
        const angle = Math.atan2(dy, dx);

        Body.applyForce(body, body.position, {
          x: Math.cos(angle) * force,
          y: Math.sin(angle) * force
        });
      }
    }
  });
</script>
</body>
</html>
